{% extends "base.html" %}
{% load static %}
{% block css %}
    <style>
        .node {
            stroke: #fff;
            stroke-width: 2px;
        }
        
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }
        
        .mytooltip {
            position: absolute;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 5px;
            display: none;
            max-width: 200px; /* Set maximum width here */
        }
    </style>
{% endblock %}

{% block content %}
    <svg id="network" width="800" height="600"></svg>
    <div id="mytooltip" class="mytooltip">
        <div id="mytooltipText"></div>
    	<img id="mytooltipImage" src="" alt="Tooltip Image" style="max-width: 100px; max-height: 100px;">
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const svg = d3.select("#network"),
            width = +svg.attr("width"),
            height = +svg.attr("height");

		var networkData = {{ graph_json|safe }};
		const nodes = networkData.nodes;
		const links = networkData.links;

        const link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("class", "link")
            .attr("stroke-width", 2);

        const node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(nodes)
            .enter().append("circle")
            .attr("class", "node")
            .attr("r", 8)
            .attr("fill", d => d.color)
            .on("mouseover", showTooltip)
            .on("mouseout", hideTooltip);

        node.append("title")
            .text(d => d.name);

        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(100))
            .force("charge", d3.forceManyBody().strength(-100))
            .force("center", d3.forceCenter(width / 2, height / 2));

        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
        });

        function showTooltip(event, d) {
            const tooltip = d3.select("#mytooltip");
            const tooltipImage = d3.select("#mytooltipImage");
            const tooltipText = d3.select("#mytooltipText");

            tooltipText.text(d.name);

			if (d.image_url) {
		        tooltipImage.style("display", "block")
		                     .attr("src", d.image_url);
			} else {
		        tooltipImage.style("display", "none");
			}

            tooltip.style("display", "block")
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 20) + "px");
        }

        function hideTooltip() {
            d3.select("#mytooltip").style("display", "none");
        }
    </script>
{% endblock %}