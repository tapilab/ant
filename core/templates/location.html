{% extends "base.html" %}
{% load static %}
{% block css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
crossorigin=""/>
    <style>

        #map {
            height:500px;
            width: 100%;
        }

    </style>
{% endblock %}

{% block content %}

<h1>Entity Map</h1>

    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
</div>

<script>
    // Initialize Map
    var map = L.map('map').setView([20, 0], 2); // Default center and zoom

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);



    var locations = [
            {% for rel in location_relationships %}
                {
                    "source_entity_key": "{{ rel.source_entity_key }}",
                    "relationship_type": "{{ rel.relationship_type }}",
                    "source_entity_type": "{{ rel.source_entity_type}}",
                    "location_key": "{{ rel.location_key }}",
                    "lat": {% if rel.latitude is not None %}{{ rel.latitude }}{% else %}null{% endif %},
                    "lng": {% if rel.longitude is not None %}{{ rel.longitude }}{% else %}null{% endif %}
                }
                {% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
    locations.forEach(rel => {
        if (rel.lat !== null && rel.lng !== null) {
            let marker = L.marker([rel.lat, rel.lng]).addTo(map);
            let popupContent = `<b> <a href="/entity/?type=${rel.source_entity_type}&key=${rel.source_entity_key}" target="_blank">${rel.source_entity_key}</a></b> ${rel.relationship_type}<br>
                                   <b><a href="/entity/?type=Location&key=${rel.location_key}" target="_blank">${rel.location_key}</a></b>`;

            marker.bindPopup(popupContent);
        }
    });


</script>


{% endblock %}
